# 接口文档

| 变更人 | 变更日期   | 变更内容   |
| ------ | ---------- | ---------- |
| 谭子悦 | 2023/05/26 | 文档初始化 |

> ⚠️ Note: 所有的接口中，时间都通过 UNIX Epoch Millisecond 表示

## 1. GET 获取当前存在的 Repo 列表

### 1.1 接口解释

获取当前已经分析完成的数据库列表。

### 1.2 请求路径

`/repo/list`

### 1.3 请求参数

无

### 1.4 响应

```typescript
interface Result {
  code: number;
  msg: string;
  data: Array<{
    id: number; // Repo id
    owner: string;
    name: string;
    fullName: string; // Repo 全名
    htmlUrl: string; // 对应的 github HTML URL
    lastUpdate: number; // 最后一次分析的更新时间
  }>;
}
```

Example:

```json
{
  "code": 0,
  "msg": "Success",
  "data": [
    {
      "id": 75164823,
      "owner": "apache",
      "name": "apache",
      "fullName": "apache/rocketmq",
      "htmlUrl": "https://github.com/apache/rocketmq",
      "lastUpdate": 1684827603186
    }
  ]
}
```

### 1.5 错误情况

无

## 2. GET 获取一个 Repo 的具体信息

### 2.1 接口解释

获取一个 Repo 的具体信息

### 2.2 请求路径

`/repo/{owner}/{name}`

### 2.3 请求参数

| 名称    | 位置 | 类型   | 是否必须 | 中文名 | 说明 |
| ------- | ---- | ------ | -------- | ------ | ---- |
| `owner` | path | string | yes      |
| `name`  | path | string | yes      |

### 2.4 响应

```typescript
interface Result {
  code: number;
  msg: string;
  data: {
    id: number; // Repo id
    owner: string;
    name: string;
    fullName: string; // Repo 全名
    htmlUrl: string; // 对应的 github HTML URL
    lastUpdate: number; // 最后一次分析的更新时间
  };
}
```

Example:

```json
{
  "code": 0,
  "msg": "Success",
  "data": {
    "id": 75164823,
    "owner": "apache",
    "name": "apache",
    "fullName": "apache/rocketmq",
    "htmlUrl": "https://github.com/apache/rocketmq",
    "lastUpdate": 1684827603186
  }
}
```

### 2.5 错误情况

无

## 3. POST 初始化一个 Repo 的分析数据

### 3.1 接口解释

用于尚未初始化的 repo，调用本接口会自动获取仓库数据，并分析仓库中的数据内容。

- [ ] 目前还未对接自动获取服务，待后续变更

### 3.2 请求路径

`/repo/{owner}/{name}/init`

### 3.3 请求参数

| 名称    | 位置 | 类型   | 是否必须 | 中文名 | 说明 |
| ------- | ---- | ------ | -------- | ------ | ---- |
| `owner` | path | string | yes      |
| `name`  | path | string | yes      |

### 3.4 响应

返回结果代表的意思：

- `0`: 尚未完成获取/分析
- `1`: 已完成分析
- `2`: 该 Repo 不存在
- `3`: 该 Repo 不存在 Issues

```typescript
interface Result {
  code: number;
  msg: string;
  data: 0 | 1 | 2 | 3;
}
```

### 3.5 错误情况

无

## 4. GET 分页获取仓库中的 Issues

### 4.1 接口解释

分页获取仓库中的 Issues

### 4.2 请求路径

`/repo/{owner}/{name}/issues`

### 4.3 请求参数

| 名称        | 位置  | 类型   | 是否必须 | 中文名     | 说明                                                          |
| ----------- | ----- | ------ | -------- | ---------- | ------------------------------------------------------------- |
| `owner`     | path  | string | yes      |            |                                                               |
| `name`      | path  | string | yes      |            |                                                               |
| `page`      | param | number | no       | 第几页     | 默认为 0                                                      |
| `direction` | param | string | no       | 排序方向   | `desc` 或 `asc`，默认为 `desc`                                |
| `sortBy`    | param | string | no       | 排序依据   | 见下                                                          |
| `states`    | param | string | no       | Issue 状态 | 可填：`open`、`closed` 或 `open,closed`，默认为 `open,closed` |

`SortBy` 的可选项：

- `issueNumber`：按 Issue Number 排序，为默认选项
- `createdAt`：按创建日期排序
- `scaleVal`：按情感 Scale 分值排序

### 4.4 响应

```typescript
interface Result {
  code: number;
  msg: string;
  data: {
    pageCount: number; // 总页数
    pageSize: number; // 一页的大小
    pageNo: number; // 当前的页数
    contentList: Array<{
      id: number;
      repoFullName: string;
      issueNumber: number;
      title: string;
      state: string;
      htmlUrl: string;
      author: string;

      createdAt: number;
      updatedAt: number;

      body: string;
      comments: number; // 评论数量

      posVal: number; // 正向情感值
      negVal: number;
      scaleVal: number; // 情感 Scale 值
    }>;
  };
}
```

Example:

```json
{
  "code": 0,
  "msg": "Success",
  "data": {
    "contentList": [
      {
        "id": 1719687984,
        "repoFullName": "Apache/RocketMQ",
        "issueNumber": 6792,
        "title": "[Bug] The \"send\" method blocked on log.warn  for a long time",
        "state": "open",
        "htmlUrl": "https://github.com/apache/rocketmq/issues/6792",
        "author": "DL1231",
        "createdAt": 1684732941000,
        "updatedAt": 1684732941000,
        "body": "Something...",
        "comments": 0,
        "posVal": 2,
        "negVal": -2,
        "scaleVal": 0
      }
    ],
    "pageCount": 67,
    "pageSize": 1,
    "pageNo": 0
  }
}
```

### 4.5 错误情况

无

## 5. GET 获取一个 Repo 中所有的 Releases

### 5.1 接口解释

获取一个 Repo 中所有的 Releases

### 5.2 请求路径

`/repo/{owner}/{name}/releases`

### 5.3 请求参数

| 名称    | 位置 | 类型   | 是否必须 | 中文名 | 说明 |
| ------- | ---- | ------ | -------- | ------ | ---- |
| `owner` | path | string | yes      |
| `name`  | path | string | yes      |

### 5.4 响应

```typescript
interface Result {
  code: number;
  msg: string;
  data: Array<{
    id: number;
    repoFullName: string;
    tagName: string;
    createdAt: number;
  }>;
}
```

Example:

```json
{
  "code": 0,
  "msg": "Success",
  "data": [
    {
      "id": 35018636,
      "repoFullName": "Apache/RocketMQ",
      "tagName": "rocketmq-all-4.8.0",
      "createdAt": 1607393826000
    },
    {
      "id": 102978605,
      "repoFullName": "Apache/RocketMQ",
      "tagName": "rocketmq-all-5.1.1",
      "createdAt": 1684119061000
    },
    {
      "id": 103285201,
      "repoFullName": "Apache/RocketMQ",
      "tagName": "rocketmq-all-4.9.6",
      "createdAt": 1684285937000
    }
  ]
}
```

### 5.5 错误情况

无

## 6. GET 获取一个 Repo 的趋势图数据

### 6.1 接口解释

获取一个 Repo 的趋势图数据

### 6.2 请求路径

`/repo/{owner}/{name}/tendency`

### 6.3 请求参数

| 名称          | 位置  | 类型   | 是否必须 | 中文名     | 说明         |
| ------------- | ----- | ------ | -------- | ---------- | ------------ |
| `owner`       | path  | string | yes      |
| `name`        | path  | string | yes      |
| `granularity` | param | string | yes      | 横坐标粒度 | 可选粒度见下 |

- `year` 年份
- `quarter` 年季度
- `month` 年月
- `release` 发布版本
  - 一个版本的数据为该版本创建后到下一次版本创建前的数据

### 6.4 响应

> Note: 当采取 release 为粒度时，返回的第一项 milestone 为 `No release`，代表第一次 release 创建前的 repo 数据。

```typescript
interface Result {
  code: number;
  msg: string;
  data: Array<{
    milestone: string; // 里程碑，横坐标标签
    // 以下统计值均为截至该点的数据
    sum: number; // Scale 分值总和
    count: number; // 总条目数
    avg: number; // 分值平均值

    posCnt: number; // 正向分值总数
    posRatio: number; // 正向分值占比

    negCnt: number; // 负向分值总数
    negRatio: number; // 负向分值占比
  }>;
}
```

Example:

```json
{
  "code": 0,
  "msg": "Success",
  "data": [
    {
      "milestone": "2018",
      "sum": -39,
      "count": 270,
      "avg": -0.14444444444444443,
      "posCnt": 40,
      "posRatio": 0.14814814814814814,
      "negCnt": 72,
      "negRatio": 0.26666666666666666
    },
    {
      "milestone": "2019",
      "sum": -197,
      "count": 696,
      "avg": -0.28304597701149425,
      "posCnt": 76,
      "posRatio": 0.10919540229885058,
      "negCnt": 229,
      "negRatio": 0.3290229885057471
    },
    {
      "milestone": "2020",
      "sum": -335,
      "count": 1234,
      "avg": -0.2714748784440843,
      "posCnt": 149,
      "posRatio": 0.12074554294975688,
      "negCnt": 401,
      "negRatio": 0.3249594813614263
    },
    {
      "milestone": "2021",
      "sum": -507,
      "count": 1800,
      "avg": -0.2816666666666667,
      "posCnt": 210,
      "posRatio": 0.11666666666666667,
      "negCnt": 597,
      "negRatio": 0.33166666666666667
    },
    {
      "milestone": "2022",
      "sum": -638,
      "count": 2856,
      "avg": -0.22338935574229693,
      "posCnt": 489,
      "posRatio": 0.17121848739495799,
      "negCnt": 924,
      "negRatio": 0.3235294117647059
    },
    {
      "milestone": "2023",
      "sum": -559,
      "count": 3345,
      "avg": -0.16711509715994022,
      "posCnt": 692,
      "posRatio": 0.20687593423019432,
      "negCnt": 1028,
      "negRatio": 0.30732436472346786
    }
  ]
}
```

### 6.5 错误情况

无

## 7. POST 获取一个 Repo 的总体分值

### 7.1 接口解释

选择纳入计算的 release，获取一个仓库的总体分值

### 7.2 请求路径

`/repo/{owner}/{name}/total`

### 7.3 请求参数

| 名称          | 位置 | 类型   | 是否必须 | 中文名                      | 说明                                |
| ------------- | ---- | ------ | -------- | --------------------------- | ----------------------------------- |
| `owner`       | path | string | yes      |
| `name`        | path | string | yes      |
| `releaseTags` | body | list   | yes      | 需要纳入计算的 release 列表 | 填入 release tag，或者 `No release` |

Request Body 示例：

```json
{
  "releaseTags": ["No release", "rocketmq-all-4.8.0"]
}
```

### 7.4 响应

```typescript
interface Result {
  code: number;
  msg: string;
  data: Array<{
    sum: number; // Scale 分值总和
    count: number; // 总条目数
    avg: number; // 分值平均值

    posCnt: number; // 正向分值总数
    posRatio: number; // 正向分值占比

    negCnt: number; // 负向分值总数
    negRatio: number; // 负向分值占比
  }>;
}
```

```json
{
  "code": 0,
  "msg": "Success",
  "data": {
    "sum": 23,
    "count": 150,
    "avg": 0.15333333333333332,
    "posCnt": 53,
    "posRatio": 0.35333333333333333,
    "negCnt": 29,
    "negRatio": 0.19333333333333333
  }
}
```

### 7.5 错误情况

无

## 8. GET 获取一个 Repo 的饼状图数据

### 8.1 接口解释

获取一个 Repo 的饼状图数据，为各分值在一定时间范围内的占比。

### 8.2 请求路径

`/repo/{owner}/{name}/pieChart`

### 8.3 请求参数

| 名称    | 位置  | 类型   | 是否必须 | 中文名     | 说明 |
| ------- | ----- | ------ | -------- | ---------- | ---- |
| `owner` | path  | string | yes      |
| `name`  | path  | string | yes      |
| `from`  | param | number | yes      | 开始时间戳 |
| `to`    | param | number | yes      | 结束时间戳 |

### 8.4 响应

```typescript
interface Result {
  code: number;
  msg: string;
  data: Map<number, number>;
}
```

```json
{
  "code": 0,
  "msg": "Success",
  "data": {
    "-1": 436,
    "0": 933,
    "-2": 115,
    "1": 173,
    "-3": 9,
    "2": 16,
    "-4": 0,
    "3": 3,
    "-5": 0,
    "4": 0,
    "5": 0
  }
}
```

### 8.5 错误情况

无
